<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.7.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="YoungFar">

  
  
  
    
  
  <meta name="description" content="1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ 2. ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ 2.1. å¤±è´¥ä¾‹å­1 2.2. å¤±è´¥ä¾‹å­2 2.3. å¤±è´¥ä¾‹å­3 3. åŸå­æ“ä½œå®ç°â€”â€”atomic.hè§£æ 4. å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ 5. åŸå­">

  
  <link rel="alternate" hreflang="en-us" href="https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/">

  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love&amp;Share">
  <meta property="og:url" content="https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/">
  <meta property="og:title" content="åŸå­æ“ä½œ atomic.h è¯¦è§£ | YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love&amp;Share">
  <meta property="og:description" content="1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ 2. ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ 2.1. å¤±è´¥ä¾‹å­1 2.2. å¤±è´¥ä¾‹å­2 2.3. å¤±è´¥ä¾‹å­3 3. åŸå­æ“ä½œå®ç°â€”â€”atomic.hè§£æ 4. å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ 5. åŸå­"><meta property="og:image" content="https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/featured.jpg">
  <meta property="twitter:image" content="https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/featured.jpg"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-10-29T20:29:10&#43;08:00">
    
    <meta property="article:modified_time" content="2020-10-29T20:29:10&#43;08:00">
  

  


    











<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"
  },
  "headline": "åŸå­æ“ä½œ atomic.h è¯¦è§£",
  
  "image": [
    "https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/featured.jpg"
  ],
  
  "datePublished": "2020-10-29T20:29:10+08:00",
  "dateModified": "2020-10-29T20:29:10+08:00",
  
  "author": {
    "@type": "Person",
    "name": "youngfar"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love\u0026Share",
    "logo": {
      "@type": "ImageObject",
      "url": "img/https://strivefar.github.io/"
    }
  },
  "description": "1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ 2. ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ 2.1. å¤±è´¥ä¾‹å­1 2.2. å¤±è´¥ä¾‹å­2 2.3. å¤±è´¥ä¾‹å­3 3. åŸå­æ“ä½œå®ç°â€”â€”atomic.hè§£æ 4. å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ 5. åŸå­"
}
</script>

  

  


  


  





  <title>åŸå­æ“ä½œ atomic.h è¯¦è§£ | YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love&amp;Share</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>æœç´¢</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="æœç´¢..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  

<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love&amp;Share</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆª">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">YoungFarçš„ä¸ªäººåšå®¢â€”â€”Love&amp;Share</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>åˆ†ç±»/ä¸“æ </span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#hero"><span>å…³äºæˆ‘</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>è¯·æˆ‘å–æ¯é…’</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item">
        <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article article-project">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>åŸå­æ“ä½œ atomic.h è¯¦è§£</h1>

  
  <p class="page-subtitle">å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿è¯„è®ºåŒºæ‰¹è¯„æŒ‡æ­£ã€‚ ğŸš€&rsquo;</p>
  

  


<div class="article-metadata">

  
  
  
  
  <div>
    



  
  <span><a href="/authors/youngfar/">youngfar</a></span>

  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    2020-10-29
  </span>
  

  

  

  
  
  

  
  

</div>

  














</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 960px;">
  <div style="position: relative">
    <img src="/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/featured_hu02ad17b9e2562b529e8fb560e78bc2ab_1816471_720x0_resize_q90_lanczos.jpg" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <ul>
<li><a href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C">1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ</a></li>
<li><a href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C">2. ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ</a>
<ul>
<li><a href="#21-%E5%A4%B1%E8%B4%A5%E4%BE%8B%E5%AD%901">2.1. å¤±è´¥ä¾‹å­1</a></li>
<li><a href="#22-%E5%A4%B1%E8%B4%A5%E4%BE%8B%E5%AD%902">2.2. å¤±è´¥ä¾‹å­2</a></li>
<li><a href="#23-%E5%A4%B1%E8%B4%A5%E4%BE%8B%E5%AD%903">2.3. å¤±è´¥ä¾‹å­3</a></li>
</ul>
</li>
<li><a href="#3-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%AE%9E%E7%8E%B0atomich%E8%A7%A3%E6%9E%90">3. åŸå­æ“ä½œå®ç°â€”â€”atomic.hè§£æ</a></li>
<li><a href="#4-%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C">4. å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ</a></li>
<li><a href="#5-%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E5%86%85%E6%A0%B8%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%E6%B1%87%E6%80%BB">5. åŸå­å˜é‡å†…æ ¸æ“ä½œå‡½æ•°æ±‡æ€»</a>
<ul>
<li><a href="#51-%E6%93%8D%E4%BD%9C%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F">5.1. æ“ä½œåŸå­å˜é‡</a></li>
<li><a href="#52-%E6%93%8D%E4%BD%9C%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E6%9F%90%E4%B8%80%E4%BD%8D">5.2. æ“ä½œåŸå­å˜é‡ä¸­çš„æŸä¸€ä½</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E6%9D%A5%E6%BA%90">å‚è€ƒæ¥æº</a></li>
</ul>
<h1 id="1-ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ">1. ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ</h1>
<p>åŸå­ï¼ˆatomï¼‰æŒ‡<code>åŒ–å­¦ååº”ä¸å¯å†åˆ†</code>çš„åŸºæœ¬å¾®ç²’ï¼ŒåŸå­åœ¨åŒ–å­¦ååº”ä¸­ä¸å¯åˆ†å‰²ã€‚</p>
<p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨åŸå­çš„è¿™ä¸€ç‰¹æ€§å½¢è±¡ç”ŸåŠ¨çš„æè¿°äº†ä¸€ç§æ“ä½œâ€”â€”â€”â€”åŸå­æ“ä½œï¼Œé¡¾åæ€ä¹‰ï¼ŒåŸå­æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œ <strong>åœ¨æ‰§è¡Œå®Œæ¯•ä¹‹å‰ä¸è¢«ä»»ä½•å…¶å®ƒä»»åŠ¡æˆ–äº‹ä»¶ä¸­æ–­æˆ–å³ä¾¿è¢«ä¸­æ–­ä½†ä¸å½±å“æœ€ç»ˆç»“æœçš„æ“ä½œéƒ½å¯ä»¥ç§°ä¹‹ä¸ºåŸå­æ“ä½œ</strong>ã€‚</p>
<p>åœ¨<strong>å•å¤„ç†å™¨ç³»ç»Ÿ</strong>ï¼ˆUniProcessorï¼‰ä¸­ï¼Œèƒ½å¤Ÿåœ¨å•æ¡æŒ‡ä»¤ä¸­å®Œæˆçš„æ“ä½œéƒ½å¯ä»¥è®¤ä¸ºæ˜¯&rdquo; åŸå­æ“ä½œ&rdquo;ï¼Œå› ä¸ºä¸­æ–­åªèƒ½å‘ç”ŸäºæŒ‡ä»¤ä¹‹é—´ï¼›é‚£ä¹ˆå¤šæ¡æŒ‡ä»¤å¯ä¸å¯ä»¥æ„æˆåŸå­æ“ä½œå‘¢ï¼Œå½“ç„¶å¯ä»¥ï¼Œåªè¦<code>ç¡®ä¿è¿™å‡ æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶ä¸è¢«æŠ¢å </code>å°±å¥½äº†ï¼Œå…³é—­æ€»ä¸­æ–­å°±å¯ä»¥åšåˆ°ã€‚</p>
<p>åœ¨<strong>å¤šå¤„ç†å™¨SMPç³»ç»Ÿ</strong>ï¼ˆSymmetric Multi-Processorï¼‰ä¸­ï¼Œå…³ä¸­æ–­å¯å°±ä¸å¥½ä½¿äº†ï¼Œå› ä¸ºAå¤„ç†å™¨æ— æ³•å…³é—­å®ƒå¤„ç†å™¨çš„ä¸­æ–­ï¼ŒAå¤„ç†å™¨åªèƒ½å…³é—­è‡ªå·±çš„ä¸­æ–­ã€‚é‚£ä¹ˆæ­¤æ—¶å¤šæ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿˜å¯ä»¥æ˜¯â€œ åŸå­ â€çš„å—ï¼Œå…¶å®ä¹Ÿèƒ½ï¼Œè™½ç„¶è¢«æŠ¢å æ˜¯å†æ‰€éš¾å…çš„ï¼Œä½†åªè¦<code>ä¿è¯è¢«æŠ¢å è€…ä¸ä¼šå½±å“åŸæ‰§è¡Œè€…çš„æœ€ç»ˆç»“æœ</code>ä¸å°±å¥½äº†ã€‚</p>
<h1 id="2-ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ">2. ä¸ºä»€ä¹ˆè¦å¼•å…¥åŸå­æ“ä½œ</h1>
<p>å…ˆæ˜ç¡®ä¸¤ä¸ªæ¦‚å¿µï¼šåŒæ­¥å’Œäº’æ–¥</p>
<ol>
<li>åŒæ­¥ï¼Œåˆç§°ç›´æ¥åˆ¶çº¦å…³ç³»ï¼Œæ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼‰ä¸ºäº†åˆä½œå®Œæˆä»»åŠ¡ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§„å®šçš„ æŸç§å…ˆåæ¬¡åºæ¥è¿è¡Œã€‚</li>
<li>äº’æ–¥ï¼Œåˆç§°é—´æ¥åˆ¶çº¦å…³ç³»ï¼Œæ˜¯æŒ‡ç³»ç»Ÿä¸­çš„æŸäº›å…±äº«èµ„æºï¼Œä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è®¿é—®è¯¥ä¸´ç•Œèµ„æºæ—¶ï¼Œå…¶å®ƒçº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚</li>
</ol>
<p>è¿™é‡Œä¸¾å‡ ä¸ªåŒæ­¥ä¸äº’æ–¥å¤±è´¥çš„ä¾‹å­æ¥è¯´æ˜æ„å»ºåŸå­æ“ä½œçš„å¿…è¦æ€§ï¼Œè¯¥éƒ¨åˆ†å†…å®¹å®Œå…¨æ‘˜è‡ªéŸ¦ä¸œå±±è€å¸ˆçš„æ•™ç¨‹æ–‡æ¡£ã€‚</p>
<h2 id="21-å¤±è´¥ä¾‹å­1">2.1. å¤±è´¥ä¾‹å­1</h2>
<pre><code class="language-c">01 static int valid = 1;
02
03 static ssize_t gpio_key_drv_open (struct inode *node, struct file *file)
04 {
05      if (!valid)
06      {
07              return -EBUSY;
08      }
09      else
10      {
11              valid = 0;
12      }
13
14      return 0; //æˆåŠŸ
15 }
16
17 static int gpio_key_drv_close (struct inode *node, struct file *file)
18 {
19      valid = 1;
20      return 0;
21 }
</code></pre>
<p>çœ‹ç¬¬5è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡validæ¥å®ç°äº’æ–¥è®¿é—®ã€‚è¿™æœ‰é—®é¢˜å—ï¼Ÿå¾ˆå¤§æ¦‚ç‡æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¹¶éä¸‡æ— ä¸€å¤±ã€‚
æ³¨æ„ï¼šç¼–å†™é©±åŠ¨ç¨‹åºæ—¶ï¼Œè¦æœ‰ç³»ç»Ÿçš„æ¦‚å¿µï¼Œç¨‹åºAè°ƒç”¨é©±åŠ¨ç¨‹åºæ—¶ï¼Œå®ƒå¯èƒ½è¢«ç¨‹åºBæ‰“æ–­ï¼Œç¨‹åºBä¹Ÿå»è°ƒç”¨è¿™ä¸ªé©±åŠ¨ç¨‹åºã€‚
ä¸‹å›¾æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œç¨‹åºAåœ¨è°ƒç”¨é©±åŠ¨ç¨‹åºçš„ä¸­é€”è¢«ç¨‹åºBæŠ¢å äº†CPUèµ„æºï¼š
<img src="/img/atomic/01.png" alt="01"></p>
<p>ç¨‹åºAæ‰§è¡Œåˆ°ç¬¬11è¡Œä¹‹å‰ï¼Œè¢«ç¨‹åºBæŠ¢å äº†ï¼Œè¿™æ—¶validå°šæœªè¢«æ”¹æˆ0ï¼›
ç¨‹åºBè°ƒç”¨gpio_key_drv_openæ—¶ï¼Œå‘ç°validç­‰äº1ï¼Œæ‰€ä»¥æˆåŠŸè¿”å›0ï¼›
å½“ç¨‹åºAç»§ç»­ä»ç¬¬11è¡Œæ‰§è¡Œæ—¶ï¼Œå®ƒæœ€ç»ˆä¹ŸæˆåŠŸè¿”å›0ï¼›
è¿™æ ·ç¨‹åºAã€Béƒ½æˆåŠŸæ‰“å¼€äº†é©±åŠ¨ç¨‹åºã€‚
æ³¨æ„ï¼šåœ¨å†…æ ¸æ€ï¼Œç¨‹åºAä¸æ˜¯ä¸»åŠ¨å»ä¼‘çœ ã€ä¸»åŠ¨æ”¾å¼ƒCPUèµ„æºï¼›è€Œæ˜¯è¢«ä¼˜å…ˆçº§æ›´é«˜çš„ç¨‹åºBæŠ¢å äº†ï¼Œè¿™ç§è¡Œä¸ºè¢«ç§°ä¸ºâ€œpreemptâ€(æŠ¢å )ã€‚</p>
<h2 id="22-å¤±è´¥ä¾‹å­2">2.2. å¤±è´¥ä¾‹å­2</h2>
<p>ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸æ˜¯ç¬¬5è¡Œåˆ°ç¬¬11è¡Œçš„æ—¶é—´è·¨åº¦å¤§é•¿äº†ï¼Ÿå†ä¼˜åŒ–ä¸€ä¸‹ç¨‹åºè¡Œä¸è¡Œï¼Ÿä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">01 static int valid = 1;
02
03 static ssize_t gpio_key_drv_open (struct inode *node, struct file *file)
04 {
05      if (--valid)
06      {
07              valid++;
08              return -EBUSY;
09      }
10      return 0;
11 }
12
13 static int gpio_key_drv_close (struct inode *node, struct file *file)
14 {
15      valid = 1;
16      return 0;
17 }
</code></pre>
<p>ç¬¬5è¡Œå…ˆå‡1å†åˆ¤æ–­ï¼Œè¿™æ ·å¯ä»¥æ›´å¤§æ¦‚ç‡åœ°é¿å…é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½ç¡®ä¿ä¸‡æ— ä¸€å¤±ã€‚å¯¹æ•°æ®çš„ä¿®æ”¹åˆ†ä¸º3æ­¥ï¼šè¯»å‡ºæ¥ã€ä¿®æ”¹ã€å†™è¿›å»ã€‚è¯·çœ‹ä¸‹å›¾ï¼š</p>
<p><img src="/img/atomic/02.png" alt="02"></p>
<p>è¿›ç¨‹Aåœ¨è¯»å‡ºvalidæ—¶å‘ç°å®ƒæ˜¯1ï¼Œå‡1åä¸º0ï¼Œè¿™æ—¶ifä¸æˆç«‹ï¼›ä½†æ˜¯ä¿®æ”¹åçš„å€¼å°šæœªå†™å›å†…å­˜ï¼›
å‡è®¾è¿™æ—¶è¢«ç¨‹åºBæŠ¢å ï¼Œç¨‹åºBè¯»å‡ºvalidä»ä¸º1ï¼Œå‡1åä¸º0ï¼Œè¿™æ—¶ifä¸æˆç«‹ï¼Œæœ€åæˆåŠŸè¿”å›ï¼›
è½®åˆ°Aç»§ç»­æ‰§è¡Œï¼Œå®ƒæŠŠ0å€¼å†™åˆ°validå˜é‡ï¼Œæœ€åä¹ŸæˆåŠŸè¿”å›ã€‚
è¿™æ ·ç¨‹åºAã€Béƒ½æˆåŠŸæ‰“å¼€äº†é©±åŠ¨ç¨‹åºã€‚</p>
<h2 id="23-å¤±è´¥ä¾‹å­3">2.3. å¤±è´¥ä¾‹å­3</h2>
<p>å‰é¢2ä¸ªä¾‹å­ï¼Œéƒ½æ˜¯åœ¨ä¿®æ”¹validçš„è¿‡ç¨‹ä¸­è¢«åˆ«çš„è¿›ç¨‹æŠ¢å äº†ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹validçš„æ—¶å€™ç›´æ¥å…³ä¸­æ–­ä¸å°±å¯ä»¥äº†å—ï¼Ÿ</p>
<pre><code class="language-c">01 static int valid = 1;
02
03 static ssize_t gpio_key_drv_open (struct inode *node, struct file *file)
04 {
05       unsigned long flags;
06       raw_local_irq_save(flags); // å…³ä¸­æ–­
07      if (--valid)
08      {
09              valid++;
10              raw_local_irq_restore(flags);  // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
11              return -EBUSY;
12      }
13       raw_local_irq_restore(flags);          // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
14      return 0;
15 }
16
17 static int gpio_key_drv_close (struct inode *node, struct file *file)
18 {
19      valid = 1;
20      return 0;
21 }
</code></pre>
<p>ç¬¬06è¡Œç›´æ¥å…³ä¸­æ–­ï¼Œè¿™æ ·åˆ«çš„çº¿ç¨‹ã€ä¸­æ–­éƒ½ä¸èƒ½æ¥æ‰“æ‰°æœ¬çº¿ç¨‹äº†ï¼Œåœ¨å®ƒè¯»å–ã€ä¿®æ”¹validå˜é‡çš„è¿‡ç¨‹ä¸­æ— äººæ‰“æ‰°ã€‚</p>
<p>æ²¡æœ‰é—®é¢˜äº†ï¼Ÿ</p>
<p><code>å¯¹äºå•CPUæ ¸çš„ç³»ç»Ÿä¸Šè¿°ä»£ç æ˜¯æ²¡é—®é¢˜çš„</code>ï¼›ä½†æ˜¯å¯¹äºSMPç³»ç»Ÿï¼Œä½ <code>åªèƒ½å…³é—­å½“å‰CPUæ ¸çš„ä¸­æ–­</code>ï¼Œåˆ«çš„CPUæ ¸è¿˜å¯ä»¥è¿è¡Œç¨‹åºï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥æ¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼ŒåŒæ ·å¯¼è‡´é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="/img/atomic/03.png" alt="03"></p>
<p>å‡è®¾CPU0ä¸Šè¿›ç¨‹Aã€CPU1ä¸Šè¿›ç¨‹BåŒæ—¶è¿è¡Œåˆ°ä¸Šå›¾ä¸­è¯»å‡ºvalidçš„åœ°æ–¹ï¼Œå®ƒä»¬åŒæ—¶å‘ç°validéƒ½æ˜¯1ï¼Œå‡å‡åéƒ½ç­‰äº0ï¼Œåœ¨ç¬¬07è¡Œåˆ¤æ–­æ¡ä»¶éƒ½ä¸æˆç«‹ï¼Œæ‰€ä»¥åœ¨ç¬¬14è¡Œéƒ½å¯ä»¥è¿”å›0ï¼Œéƒ½å¯ä»¥æˆåŠŸæ‰“å¼€é©±åŠ¨ã€‚</p>
<h1 id="3-åŸå­æ“ä½œå®ç°atomichè§£æ">3. åŸå­æ“ä½œå®ç°â€”â€”atomic.hè§£æ</h1>
<p>ä¸ºæ–¹ä¾¿è¯´æ˜ï¼Œè¿™é‡Œå¯¹ä¸€äº›éå…³é”®çš„æ¡ä»¶ç¼–è¯‘ä¸åšå±•å¼€è¯´æ˜ï¼Œå®Œæ•´çš„atomic.hæ–‡ä»¶è·¯å¾„ä¸ºarch/arm/include/asm/atomic.hï¼Œæ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ï¼Œåœ¨çº¿æŸ¥çœ‹arch/arm/include/asm/atomic.hæºç </p>
<p><a href="https://elixir.bootlin.com/linux/v4.9.88/source/arch/arm/include/asm/atomic.h">atomic.hæºç åœ¨çº¿é˜…è¯»</a></p>
<pre><code class="language-c">#ifndef __ASM_ARM_ATOMIC_H
#define __ASM_ARM_ATOMIC_H

#include &lt;linux/compiler.h&gt;
#include &lt;linux/prefetch.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/irqflags.h&gt;
#include &lt;asm/barrier.h&gt;
#include &lt;asm/cmpxchg.h&gt;

#define ATOMIC_INIT(i) \
    {                  \
        (i)            \
    }

#ifdef __KERNEL__    


/* è¯»å†™æ“ä½œåªéœ€è¦ä¸€æ¡æŒ‡ä»¤å³å¯å®Œæˆï¼Œæœ¬èº«å°±æ˜¯åŸå­çš„ */
#define atomic_read(v) READ_ONCE((v)-&gt;counter) 
#define atomic_set(v, i) WRITE_ONCE(((v)-&gt;counter), (i))

/*******************************************************************/

/*
* æ ¹æ®ä¸åŒæ¶æ„ç‰ˆæœ¬åšè®¾ç½®ä¸åŒçš„#defineå®å‡½æ•°
* ARMV6 ä»¥ä¸‹ï¼Œå•æ ¸ï¼Œæ— éœ€å†…è”æ±‡ç¼–ï¼Œç›´æ¥å…³ä¸­æ–­
* ARMv6 åŠä»¥ä¸Šï¼Œæ”¯æŒå¤šæ ¸ï¼Œä¸€å¾‹å†…è”æ±‡ç¼–ï¼
*/
#if __LINUX_ARM_ARCH__ &gt;= 6 
... Section A
#else
... Section B
#endif /* __LINUX_ARM_ARCH__ */

/*******************************************************************/


/* 
* ATOMIC_OPS è¡¨ç¤º opså³operations è¡¨ç¤ºä¸€ç³»åˆ—åŸå­æ“ä½œï¼Œ
* ATOMIC_OPï¼Œ ATOMIC_OP_RETURNï¼ŒATOMIC_FETCH_OPè¿™å‡ ä¸ªå® åœ¨ çœç•¥éƒ¨åˆ†A å’Œ çœç•¥éƒ¨åˆ†B å„æœ‰ä¸åŒçš„å®šä¹‰
*/
#define ATOMIC_OPS(op, c_op, asm_op)   \
    ATOMIC_OP(op, c_op, asm_op)        \  //è¿™ä¸ªå®è¿˜æ˜¯æ²¡å˜
    ATOMIC_OP_RETURN(op, c_op, asm_op) \
    ATOMIC_FETCH_OP(op, c_op, asm_op)

ATOMIC_OPS(add, +=, add)
ATOMIC_OPS(sub, -=, sub)

#define atomic_andnot atomic_andnot

/*******************************************************************/

/* åˆ é™¤åŸæ¥çš„ATOMIC_OPSå® */
#undef ATOMIC_OPS  
/* é‡æ–°å®šä¹‰æ–°çš„ä¸€ç³»åˆ—åŸå­æ“ä½œ */
#define ATOMIC_OPS(op, c_op, asm_op) \
    ATOMIC_OP(op, c_op, asm_op)      \  //è¿™ä¸ªå®è¿˜æ˜¯æ²¡å˜
    ATOMIC_FETCH_OP(op, c_op, asm_op)

ATOMIC_OPS(and, &amp;=, and)
ATOMIC_OPS(andnot, &amp;= ~, bic)
ATOMIC_OPS(or, |=, orr)
ATOMIC_OPS(xor, ^=, eor)


/*******************************************************************/
/* åˆ é™¤åŸæ¥çš„å„ä¸ªå®ï¼Œå°†å·²å®šä¹‰çš„è¿™äº›å®çš„ä½œç”¨åŸŸé™åˆ¶åœ¨äº†æ”¹è¡Œä»¥ä¸Šï¼Œåœ¨è¯¥è¡Œä¹‹åï¼Œå¦‚åˆè°ƒç”¨è¯¥æ ‡è¯†ç¬¦ï¼Œåˆ™ç¨‹åºä¼šç¼–è¯‘å‡ºé”™ */
#undef ATOMIC_OPS
#undef ATOMIC_FETCH_OP
#undef ATOMIC_OP_RETURN
#undef ATOMIC_OP

#define atomic_xchg(v, new) (xchg(&amp;((v)-&gt;counter), new))

#define atomic_inc(v) atomic_add(1, v)
#define atomic_dec(v) atomic_sub(1, v)

#define atomic_inc_and_test(v) (atomic_add_return(1, v) == 0)
#define atomic_dec_and_test(v) (atomic_sub_return(1, v) == 0)
#define atomic_inc_return_relaxed(v) (atomic_add_return_relaxed(1, v))
#define atomic_dec_return_relaxed(v) (atomic_sub_return_relaxed(1, v))
#define atomic_sub_and_test(i, v) (atomic_sub_return(i, v) == 0)

#define atomic_add_negative(i, v) (atomic_add_return(i, v) &lt; 0)
/*******************************************************************/

/*å¦‚æœæ˜¯64ä½çš„ç³»ç»Ÿï¼Œåˆ™é‡å¤32ä½çš„æµç¨‹ï¼Œåªæ˜¯è®©æ“ä½œé€‚é…64ä½ç³»ç»Ÿ*/
#ifndef CONFIG_GENERIC_ATOMIC64
... çœç•¥
#endif /* !CONFIG_GENERIC_ATOMIC64 */
/*******************************************************************/

#endif /* end of __KERNEL__ */

#endif /* end of __ASM_ARM_ATOMIC_H */

</code></pre>
<p>åˆšåˆšçœç•¥æ‰çš„Section A çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">/*
 * ARMv6 UP and SMP safe atomic ops.  We use load exclusive and
 * store exclusive to ensure that these are atomic.  We may loop
 * to ensure that the update happens.
 *
 * ARMv6 UPå’ŒSMPå®‰å…¨åŸå­æ“ä½œã€‚æˆ‘ä»¬ä½¿ç”¨åŠ è½½ç‹¬å å’Œå­˜å‚¨ç‹¬å æ¥ç¡®ä¿å®ƒä»¬æ˜¯åŸå­çš„ã€‚
 * æˆ‘ä»¬å¯ä»¥å¾ªç¯ä»¥ç¡®ä¿æ›´æ–°å‘ç”Ÿã€‚
 */


/*
* è¿™éƒ¨åˆ†ä¸»è¦å®šä¹‰äº†å®æ“ä½œï¼Œç„¶åäºŒæ¬¡å°è£…è¿›ATOMIC_OPSå®ä¸­ï¼Œ
* è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ç±»ä¼¼ATOMIC_OPS(and, &amp;=, and)è¿™æ ·çš„æ“ä½œåšç½®æ¢äº†
*/
#define ATOMIC_OP(op, c_op, asm_op)                                         \
    static inline void atomic_##op(int i, atomic_t *v)                      \
    {                                                                       \
        unsigned long tmp;                                                  \
        int result;                                                         \
                                                                            \
        prefetchw(&amp;v-&gt;counter);                                             \
        __asm__ __volatile__(&quot;@ atomic_&quot; #op &quot;\n&quot;                           \
                             &quot;1:	ldrex	%0, [%3]\n&quot;                          \
                             &quot;	&quot; #asm_op &quot;	%0, %0, %4\n&quot;                   \
                             &quot;	strex	%1, %0, [%3]\n&quot;                        \
                             &quot;	teq	%1, #0\n&quot;                                \
                             &quot;	bne	1b&quot;                                      \
                             : &quot;=&amp;r&quot;(result), &quot;=&amp;r&quot;(tmp), &quot;+Qo&quot;(v-&gt;counter) \
                             : &quot;r&quot;(&amp;v-&gt;counter), &quot;Ir&quot;(i)                    \
                             : &quot;cc&quot;);                                       \
    }

#define ATOMIC_OP_RETURN(op, c_op, asm_op)                                  \
    static inline int atomic_##op##_return_relaxed(int i, atomic_t *v)      \
    {                                                                       \
        unsigned long tmp;                                                  \
        int result;                                                         \
                                                                            \
        prefetchw(&amp;v-&gt;counter);                                             \
                                                                            \
        __asm__ __volatile__(&quot;@ atomic_&quot; #op &quot;_return\n&quot;                    \
                             &quot;1:	ldrex	%0, [%3]\n&quot;                          \
                             &quot;	&quot; #asm_op &quot;	%0, %0, %4\n&quot;                   \
                             &quot;	strex	%1, %0, [%3]\n&quot;                        \
                             &quot;	teq	%1, #0\n&quot;                                \
                             &quot;	bne	1b&quot;                                      \
                             : &quot;=&amp;r&quot;(result), &quot;=&amp;r&quot;(tmp), &quot;+Qo&quot;(v-&gt;counter) \
                             : &quot;r&quot;(&amp;v-&gt;counter), &quot;Ir&quot;(i)                    \
                             : &quot;cc&quot;);                                       \
                                                                            \
        return result;                                                      \
    }

#define ATOMIC_FETCH_OP(op, c_op, asm_op)                                               \
    static inline int atomic_fetch_##op##_relaxed(int i, atomic_t *v)                   \
    {                                                                                   \
        unsigned long tmp;                                                              \
        int result, val;                                                                \
                                                                                        \
        prefetchw(&amp;v-&gt;counter);                                                         \
                                                                                        \
        __asm__ __volatile__(&quot;@ atomic_fetch_&quot; #op &quot;\n&quot;                                 \
                             &quot;1:	ldrex	%0, [%4]\n&quot;                                      \
                             &quot;	&quot; #asm_op &quot;	%1, %0, %5\n&quot;                               \
                             &quot;	strex	%2, %1, [%4]\n&quot;                                    \
                             &quot;	teq	%2, #0\n&quot;                                            \
                             &quot;	bne	1b&quot;                                                  \
                             : &quot;=&amp;r&quot;(result), &quot;=&amp;r&quot;(val), &quot;=&amp;r&quot;(tmp), &quot;+Qo&quot;(v-&gt;counter) \
                             : &quot;r&quot;(&amp;v-&gt;counter), &quot;Ir&quot;(i)                                \
                             : &quot;cc&quot;);                                                   \
                                                                                        \
        return result;                                                                  \
    }


/* è¿™é‡Œä¸æ˜¯å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆè¦é‡å¤å°è£…ï¼Œå¯èƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿ä¿®æ”¹æ¥å£å§ï¼Œè¿˜è¯·è¯„è®ºåŒºæŒ‡ç‚¹ */
#define atomic_add_return_relaxed atomic_add_return_relaxed
#define atomic_sub_return_relaxed atomic_sub_return_relaxed
#define atomic_fetch_add_relaxed atomic_fetch_add_relaxed
#define atomic_fetch_sub_relaxed atomic_fetch_sub_relaxed

#define atomic_fetch_and_relaxed atomic_fetch_and_relaxed
#define atomic_fetch_andnot_relaxed atomic_fetch_andnot_relaxed
#define atomic_fetch_or_relaxed atomic_fetch_or_relaxed
#define atomic_fetch_xor_relaxed atomic_fetch_xor_relaxed

static inline int atomic_cmpxchg_relaxed(atomic_t *ptr, int old, int new)
{
    int oldval;
    unsigned long res;

    prefetchw(&amp;ptr-&gt;counter);

    do
    {
        __asm__ __volatile__(&quot;@ atomic_cmpxchg\n&quot;
                             &quot;ldrex	%1, [%3]\n&quot;
                             &quot;mov	%0, #0\n&quot;
                             &quot;teq	%1, %4\n&quot;
                             &quot;strexeq %0, %5, [%3]\n&quot;
                             : &quot;=&amp;r&quot;(res), &quot;=&amp;r&quot;(oldval), &quot;+Qo&quot;(ptr-&gt;counter)
                             : &quot;r&quot;(&amp;ptr-&gt;counter), &quot;Ir&quot;(old), &quot;r&quot;(new)
                             : &quot;cc&quot;);
    } while (res);

    return oldval;
}
/* è¿™é‡Œä¸æ˜¯å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆè¦é‡å¤å°è£…ï¼Œå¯èƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿ä¿®æ”¹æ¥å£å§ï¼Œè¿˜è¯·è¯„è®ºåŒºæŒ‡ç‚¹ */
#define atomic_cmpxchg_relaxed atomic_cmpxchg_relaxed

static inline int __atomic_add_unless(atomic_t *v, int a, int u)
{
    int oldval, newval;
    unsigned long tmp;

    smp_mb();
    prefetchw(&amp;v-&gt;counter); //å†™é¢„å–

    __asm__ __volatile__(&quot;@ atomic_add_unless\n&quot;
                         &quot;1:	ldrex	%0, [%4]\n&quot;
                         &quot;	teq	%0, %5\n&quot;
                         &quot;	beq	2f\n&quot;
                         &quot;	add	%1, %0, %6\n&quot;
                         &quot;	strex	%2, %1, [%4]\n&quot;
                         &quot;	teq	%2, #0\n&quot;
                         &quot;	bne	1b\n&quot;
                         &quot;2:&quot;
                         : &quot;=&amp;r&quot;(oldval), &quot;=&amp;r&quot;(newval), &quot;=&amp;r&quot;(tmp), &quot;+Qo&quot;(v-&gt;counter)
                         : &quot;r&quot;(&amp;v-&gt;counter), &quot;r&quot;(u), &quot;r&quot;(a)
                         : &quot;cc&quot;);

    if (oldval != u)
        smp_mb();   //*_mb()æ˜¯è¯»å†™è®¿é—®å†…å­˜å±éšœï¼Œå®ƒä¿è¯åœ¨å±éšœï¼ˆè°ƒç”¨*_mb()çš„ä½ç½®å¤„ï¼‰ä¹‹åçš„ä»»ä½•è¯»æ“ä½œåœ¨æ‰§è¡Œä¹‹å‰ï¼Œå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½å·²ç»å®Œæˆã€‚

    return oldval;
}



</code></pre>
<p>åˆšåˆšçœç•¥æ‰çš„Section B çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">/* 
* #error æ˜¯ä¸€ç§é¢„ç¼–è¯‘å™¨æŒ‡ç¤ºå­—ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ªç¼–è¯‘é”™è¯¯æ¶ˆæ¯ã€‚
* ä¹‹å‰è¯´äº†ï¼Œå¯¹äºSMPç³»ç»Ÿï¼Œå…³ä¸­æ–­æ˜¯æ— æ³•å®ç°åŸå­æ“ä½œçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæŠ¥é”™
*/
#ifdef CONFIG_SMP
#error SMP not supported on pre-ARMv6 CPUs
#endif

/*
* raw_local_irq_save(flags); // ä¸­æ–­æ§åˆ¶ç›¸å…³,ä¿å­˜å¹¶å…³é—­ä¸­æ–­
* raw_local_irq_restore(flags); //ä¸­æ–­æ§åˆ¶ç›¸å…³,æ¢å¤ä¸­æ–­
*/
#define ATOMIC_OP(op, c_op, asm_op)                    \
    static inline void atomic_##op(int i, atomic_t *v) \
    {                                                  \
        unsigned long flags;                           \
                                                       \
        raw_local_irq_save(flags);                     \
        v-&gt;counter c_op i;                             \
        raw_local_irq_restore(flags);                  \
    }

#define ATOMIC_OP_RETURN(op, c_op, asm_op)                     \
    static inline int atomic_##op##_return(int i, atomic_t *v) \
    {                                                          \
        unsigned long flags;                                   \
        int val;                                               \
                                                               \
        raw_local_irq_save(flags);                             \
        v-&gt;counter c_op i;                                     \
        val = v-&gt;counter;                                      \
        raw_local_irq_restore(flags);                          \
                                                               \
        return val;                                            \
    }

#define ATOMIC_FETCH_OP(op, c_op, asm_op)                   \
    static inline int atomic_fetch_##op(int i, atomic_t *v) \
    {                                                       \
        unsigned long flags;                                \
        int val;                                            \
                                                            \
        raw_local_irq_save(flags);                          \
        val = v-&gt;counter;                                   \
        v-&gt;counter c_op i;                                  \
        raw_local_irq_restore(flags);                       \
                                                            \
        return val;                                         \
    }

static inline int atomic_cmpxchg(atomic_t *v, int old, int new)
{
    int ret;
    unsigned long flags;

    raw_local_irq_save(flags);
    ret = v-&gt;counter;
    if (likely(ret == old))
        v-&gt;counter = new;
    raw_local_irq_restore(flags);

    return ret;
}

static inline int __atomic_add_unless(atomic_t *v, int a, int u)
{
    int c, old;

    c = atomic_read(v);
    while (c != u &amp;&amp; (old = atomic_cmpxchg((v), c, c + a)) != c)
        c = old;
    return c;
}
</code></pre>
<h1 id="4-å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ">4. å†…è”æ±‡ç¼–å®ç°åŸå­æ“ä½œ</h1>
<p>ä¸Šé¢çš„ä»£ç åªæ˜¯å¤§ä½“è®©æˆ‘ä»¬äº†è§£äº†ä¸€ä¸‹åŸå­æ“ä½œçš„åŸºæœ¬æ¶æ„ï¼Œå•æ ¸ç³»ç»Ÿæˆ‘ä»¬ä¸åœ¨æ·±ç©¶ï¼Œä¸»è¦ç»†ç©¶ä¸€ä¸‹å¤šæ ¸ç³»ç»Ÿå¦‚ä½•å®ç°åŸå­æ“ä½œçš„ã€‚</p>
<p>æˆ‘ä»¬ä»¥Section A çš„ __atomic_add_unless å‡½æ•°ä¸ºä¾‹ï¼Œå¯¹å…¶ä¸­ä½¿ç”¨åˆ°çš„å†…è”æ±‡ç¼–åšæ·±åº¦è§£æ
è¯¥å‡½æ•°ä½“å¦‚ä¸‹ï¼š</p>
<pre><code class="language-C">  1 static inline int __atomic_add_unless(atomic_t *v, int a, int u)
  2 {
  3     int oldval, newval;
  4     unsigned long tmp;
  5
  6     smp_mb();
  7     prefetchw(&amp;v-&gt;counter); //å†™é¢„å–
  8
  9     __asm__ __volatile__(&quot;@ atomic_add_unless\n&quot;
 10                          &quot;1:    ldrex   %0, [%4]\n&quot;     ;è¯»å–counteråˆ°oldvalï¼Œå¹¶æ ‡è®°[%4]æ‰€æŒ‡çš„å†…å­˜ä¸ºç‹¬å è®¿é—®
 11                          &quot;      teq     %0, %5\n&quot;       ;æ¯”è¾ƒoldvalå’Œuæ˜¯å¦ç›¸ç­‰
 12                          &quot;      beq     2f\n&quot;           ;ç›¸ç­‰åˆ™è·³è½¬è‡³æ ‡ç­¾2ï¼Œè·³å‡ºè¯¥å‡½æ•°ï¼Œä¸ç›¸ç­‰åˆ™ç»§ç»­é¡ºåºæ‰§è¡Œä¸‹â€”æ¡æŒ‡ä»¤
 13                          &quot;      add     %1, %0, %6\n&quot;   ;newval = oldval + aï¼Œè¿™é‡Œoldval å°±æ˜¯åŸæ¥çš„counterï¼Œè¿™æ˜¯ç¬¬â‘ æ­¥çš„å½±å“
 14                          &quot;      strex   %2, %1, [%4]\n&quot; ;å¦‚æœcounterçš„ç‹¬å è®¿é—®æ ‡è®°è¿˜åœ¨ï¼Œåˆ™æŠŠnewvalæ–°å€¼å†™å…¥[%4æ‰€æŒ‡çš„å†…å­˜ï¼Œå¹¶ä¸”æ¸…é™¤ç‹¬å è®¿é—®æ ‡è®°ï¼ŒæŠŠtmpè®¾ä¸º0è¡¨ç¤ºæˆåŠŸ,tmp = 1è¡¨ç¤ºå¤±è´¥
 15                          &quot;      teq     %2, #0\n&quot;       ;æµ‹è¯•tmpçš„å€¼æ˜¯å¦ä¸º0ï¼Œä¸º0è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ï¼Œä¸º1è¡¨ç¤ºcounterçš„ç‹¬å è®¿é—®æ ‡è®°ä¸å­˜åœ¨äº†ï¼Œå°±ä¸ä¼šæ›´æ–°counterçš„å€¼
 16                          &quot;      bne     1b\n&quot;           ;å¦‚æœä¸ç›¸ç­‰åˆ™è·³è½¬åˆ°lable 1å¤„é‡æ–°æ‰§è¡Œï¼Œæ€»æœ‰â”€æ¬¡èƒ½æˆåŠŸ
 17                          &quot;2:&quot;
 18                          : &quot;=&amp;r&quot;(oldval), &quot;=&amp;r&quot;(newval), &quot;=&amp;r&quot;(tmp), &quot;+Qo&quot;(v-&gt;counter)
 19                          : &quot;r&quot;(&amp;v-&gt;counter), &quot;r&quot;(u), &quot;r&quot;(a)
 20                          : &quot;cc&quot;);
 21
 22     if (oldval != u)
 23         smp_mb();   //*_mb()æ˜¯è¯»å†™è®¿é—®å†…å­˜å±éšœï¼Œå®ƒä¿è¯åœ¨å±éšœï¼ˆè°ƒç”¨*_mb()çš„ä½ç½®å¤„ï¼‰ä¹‹åçš„ä»»ä½•è¯»æ“ä½œåœ¨æ‰§è¡Œä¹‹å‰ï¼Œå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½å·²ç»å®Œæˆã€‚
 24
 25     return oldval;
 26 }

</code></pre>
<ol>
<li>ç¬¬7è¡Œï¼šæœ‰ä¸€ä¸ªå…±è¯†æ˜¯:ç¨‹åºè®¿é—®çš„å˜é‡å¦‚æœéƒ½èƒ½åœ¨ç³»ç»Ÿå†…å­˜cacheä¸­åˆ™èƒ½æå‡æ€§èƒ½ï¼Œprefetchwæ˜¯å†…æ ¸ä¸­ä¸€ä¸ªé¢„çƒ­å†…å­˜å‡½æ•°ï¼Œè¿™æ ·ä¸‹æ¬¡éå†æ—¶å°±èƒ½é«˜æ•ˆå‘½ä¸­å†…å­˜cacheï¼Œä»è€Œæå‡ç¨‹åºæ€§èƒ½ã€‚</li>
<li>ç¬¬9è¡Œåˆ°ç¬¬20è¡Œï¼Œæ‰‹æœºç«¯è§å¦‚ä¸‹å›¾ç‰‡è§£æ
<img src="/img/atomic/04.png" alt="04"></li>
<li>ç¬¬6è¡Œå’Œ23è¡Œï¼š
<em>_mb()æ˜¯è¯»å†™è®¿é—®å†…å­˜å±éšœï¼Œå®ƒä¿è¯åœ¨å±éšœï¼ˆè°ƒç”¨</em>_mb()çš„ä½ç½®å¤„ï¼‰ä¹‹åçš„ä»»ä½•è¯»æ“ä½œåœ¨æ‰§è¡Œä¹‹å‰ï¼Œå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½å·²ç»å®Œæˆã€‚</li>
</ol>
<p>ä»”ç»†ä¸€åˆ†æï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯ï¼š</p>
<ul>
<li>åªè¦v-&gt;counterè¿˜ä¸ç­‰äºu,å°±ä»¥åŸå­çš„æ–¹å¼å°†aåŠ åˆ°v-&gt;counterä¸­ï¼Œæœ€ç»ˆè¿”å›åŸå§‹çš„v-&gt;counterçš„å€¼ï¼Œå³ä¸´æ—¶å˜é‡oldvalçš„å€¼ã€‚</li>
<li>ç”±äºè¿‡ç¨‹ä¸­ç‹¬å è®¿é—®å†…å­˜ï¼Œæ‰€ä»¥å¦‚æœå†™å›å†…å­˜æ—¶å‘ç°ç‹¬å è®¿é—®æ ‡è®°æ¶ˆå¤±ï¼Œåˆ™è¡¨æ˜è¯¥è¿›ç¨‹è¢«å…¶ä»–å¤„ç†å™¨ä¸­çš„è¿›ç¨‹æŠ¢å æ‰§è¡Œäº†ï¼Œåˆ™ä¼šé‡å¤´å†æ¥ï¼Œæ€»æœ‰ä¸€æ¬¡èƒ½æˆåŠŸï¼Œè¿™å°±ä¿è¯äº†è¢«æŠ¢å è€…ä¸ä¼šå½±å“åŸæ‰§è¡Œè€…çš„æœ€ç»ˆç»“æœï¼Œç”šæ˜¯å·§å¦™ï¼</li>
</ul>
<h1 id="5-åŸå­å˜é‡å†…æ ¸æ“ä½œå‡½æ•°æ±‡æ€»">5. åŸå­å˜é‡å†…æ ¸æ“ä½œå‡½æ•°æ±‡æ€»</h1>
<p>å…¶å®ƒçš„å‡½æ•°ä¹Ÿå¤§åŒå°å¼‚ï¼Œè¿™é‡Œè®°å½•å¦‚ä¸‹</p>
<h2 id="51-æ“ä½œåŸå­å˜é‡">5.1. æ“ä½œåŸå­å˜é‡</h2>
<table>
<thead>
<tr>
<th align="left">å‡½æ•°å</th>
<th align="left">ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">atomic_read(v)</td>
<td align="left">è¯»å‡ºåŸå­å˜é‡çš„å€¼ï¼Œå³v-&gt;counter</td>
</tr>
<tr>
<td align="left">atomic_set(v,i)</td>
<td align="left">è®¾ç½®åŸå­å˜é‡çš„å€¼ï¼Œå³v-&gt;counter = i</td>
</tr>
<tr>
<td align="left">atomic_inc(v)</td>
<td align="left">v-&gt;counter++</td>
</tr>
<tr>
<td align="left">atomic_dec(v)</td>
<td align="left">v-&gt;counter&ndash;</td>
</tr>
<tr>
<td align="left">atomic_add(i,v)</td>
<td align="left">v-&gt;counter += i</td>
</tr>
<tr>
<td align="left">atomic_sub(i,v)</td>
<td align="left">v-&gt;counter -= i</td>
</tr>
<tr>
<td align="left">atomic_inc_and_test(v)</td>
<td align="left">å…ˆåŠ 1ï¼Œå†åˆ¤æ–­æ–°å€¼æ˜¯å¦ç­‰äº0ï¼›ç­‰äº0çš„è¯ï¼Œè¿”å›å€¼ä¸º1</td>
</tr>
<tr>
<td align="left">atomic_dec_and_test(v)</td>
<td align="left">å…ˆå‡1ï¼Œå†åˆ¤æ–­æ–°å€¼æ˜¯å¦ç­‰äº0ï¼›ç­‰äº0çš„è¯ï¼Œè¿”å›å€¼ä¸º1</td>
</tr>
</tbody>
</table>
<h2 id="52-æ“ä½œåŸå­å˜é‡ä¸­çš„æŸä¸€ä½">5.2. æ“ä½œåŸå­å˜é‡ä¸­çš„æŸä¸€ä½</h2>
<table>
<thead>
<tr>
<th align="left">å‡½æ•°å</th>
<th align="left">ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">set_bit(nr,p)</td>
<td align="left">è®¾ç½®(*p)çš„bit nrä¸º1</td>
</tr>
<tr>
<td align="left">clear_bit(nr,p)</td>
<td align="left">æ¸…é™¤(*p)çš„bit nrä¸º0</td>
</tr>
<tr>
<td align="left">change_bit(nr,p)</td>
<td align="left">æ”¹å˜(*p)çš„bit nrï¼Œä»1å˜ä¸º0ï¼Œæˆ–æ˜¯ä»0å˜ä¸º1</td>
</tr>
<tr>
<td align="left">test_and_set_bit(nr,p)</td>
<td align="left">è®¾ç½®(*p)çš„bit nrä¸º1ï¼Œè¿”å›è¯¥ä½çš„è€å€¼</td>
</tr>
<tr>
<td align="left">test_and_clear_bit(nr,p)</td>
<td align="left">æ¸…é™¤(*p)çš„bit nrä¸º0ï¼Œè¿”å›è¯¥ä½çš„è€å€¼</td>
</tr>
<tr>
<td align="left">test_and_change_bit(nr,p)</td>
<td align="left">æ”¹å˜(*p)çš„bit nrï¼Œä»1å˜ä¸º0ï¼Œæˆ–æ˜¯ä»0å˜ä¸º1ï¼›è¿”å›è¯¥ä½çš„è€å€¼</td>
</tr>
</tbody>
</table>
<h1 id="å‚è€ƒæ¥æº">å‚è€ƒæ¥æº</h1>
<p>æœ¬æ–‡æ˜¯å­¦ä¹ éŸ¦ä¸œå±±è€å¸ˆçš„Linuxè¯¾ç¨‹æ•´ç†çš„ç¬”è®°ï¼Œç‰¹æ­¤æ„Ÿè°¢ï¼ï¼ï¼</p>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/linux/">linux</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/&amp;text=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/&amp;t=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3&amp;body=https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/&amp;title=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3%20https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://strivefar.github.io/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/&amp;title=%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%20atomic.h%20%e8%af%a6%e8%a7%a3" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  
  
    
  
  






  
  
  
  
  <div class="media author-card content-widget-hr">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/authors/youngfar/"></a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
  
</ul>

    </div>
  </div>



  
  <span id="/project/post/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" class="leancloud_visitors" data-flag-title="åŸå­æ“ä½œ atomic.h è¯¦è§£">
    <span class="post-meta-item-text">æ–‡ç« é˜…è¯»é‡ </span>
    <span class="leancloud-visitors-count">1000000</span>
    <p></p>
  </span>
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'bKJsEdFkCyUHc6Y1ItM5m6eJ-gzGzoHsz',
        appKey: 'HAQIcprgVn8XbQVJ0ljgsudL',
        notify: 'false', 
        verify: 'false', 
        avatar:'mm', 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
        visitor: 'true'
    });
  </script>







  
  
  <div class="article-widget content-widget-hr">
    <h3>ç›¸å…³</h3>
    <ul>
      
      <li><a href="/project/post/inline/">å†…è”æ±‡ç¼–</a></li>
      
      <li><a href="/project/post/%E8%AE%BE%E5%A4%87%E6%A0%91%E8%AF%A6%E8%A7%A3-imx6ull/">è®¾å¤‡æ ‘è¯¦è§£</a></li>
      
      <li><a href="/project/post/%E8%AE%BE%E5%A4%87%E6%A0%91%E8%AF%AD%E6%B3%95/">Linux è®¾å¤‡é©±åŠ¨å¼€å‘â€”â€”â€”â€”è®¾å¤‡æ ‘åº”ç”¨å®ä¾‹ï¼ˆimx6ullï¼‰</a></li>
      
      <li><a href="/project/post/%E6%80%BB%E7%BA%BF%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B/">æ€»çº¿è®¾å¤‡é©±åŠ¨æ¨¡å‹</a></li>
      
      <li><a href="/project/post/getting-started/">åŠ¨æ€ç¼–è¯‘å’Œé™æ€ç¼–è¯‘â€”â€”åˆ¶ä½œåŠ¨æ€åº“å’Œé™æ€åº“</a></li>
      
    </ul>
  </div>
  



    <div class="project-related-pages content-widget-hr">
      
      

      
      
      

      
      
      

      
      
      
    </div>
  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js" integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","placeholder":"æœç´¢...","results":"æœç´¢ç»“æœ"};
      const content_type = {
        'post': "æ–‡ç« ",
        'project': "é¡¹ç›®",
        'publication' : "å‡ºç‰ˆç‰©",
        'talk' : "æ¼”è®²"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.a0d331bcd05dbe8b31e244f796710f08.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å¼•ç”¨</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> å¤åˆ¶
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> ä¸‹è½½
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
